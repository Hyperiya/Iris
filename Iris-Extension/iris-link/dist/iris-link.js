(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var e;e=new class{constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isServerCheckInProgress=!1,this.progressWorker=null,this.messageQueue=[],this.lastMessageTime=0,this.messageThrottle=50,this.cleanupTimers=[],this.wasAutoSwitchedThisSong=!1,this.timingSwitch=!1,this.progress={progress:0,prevProgress:0},this.duration={duration:0,prevDuration:0},this.loopSwitch=!1,this.main()}setupProgressWorker(){var e=new Blob([`
let intervalId;
self.onmessage = function(e) {
  if (e.data === 'start') {
    intervalId = setInterval(() => {
      self.postMessage('tick');
    }, 500);
  } else if (e.data === 'stop') {
    clearInterval(intervalId);
  }
};
`],{type:"application/javascript"}),e=URL.createObjectURL(e);this.progressWorker=new Worker(e),Spicetify.Player.addEventListener("onplaypause",e=>{null!=e&&e.data.isPaused?(this.timingSwitch=!0,this.progressWorker&&this.progressWorker.postMessage("stop")):this.progressWorker&&this.progressWorker.postMessage("start")}),this.progressWorker.onmessage=()=>{if(Spicetify.Player.isPlaying()){1e3<=this.duration.prevDuration-this.progress.prevProgress&&this.progress.progress<=500&&2===Spicetify.Player.getRepeat()&&(this.loopSwitch=!0);let e=0;!this.wasAutoSwitchedThisSong&&!this.loopSwitch||this.timingSwitch||(e=-750);var t=Math.max(Spicetify.Player.getProgress()+e,0),s=Spicetify.Player.getDuration(),r=(this.progress.prevProgress=this.progress.progress,this.progress.progress=t,Math.abs(t-this.progress.prevProgress));(1e3<r||.01<r/s)&&this.throttledSendMessage(JSON.stringify({type:"progress",data:{progress:t,duration:s,percentage:Math.round(t/s*100)}}))}},this.progressWorker.postMessage("start"),URL.revokeObjectURL(e)}convertSpotifyImageUriToUrl(e){e=e.split(":").pop();return e?"https://i.scdn.co/image/"+e:""}startProgressTracking(){this.progressWorker||this.setupProgressWorker()}stopProgressTracking(){this.progressWorker&&(this.progressWorker.postMessage("stop"),this.progressWorker.terminate(),this.progressWorker=null)}async checkServerAvailable(){try{await fetch("http://127.0.0.1:5001/health",{method:"HEAD",mode:"no-cors"});return!0}catch(e){return!1}}async connectWebSocket(){if(!this.isServerCheckInProgress){this.isServerCheckInProgress=!0;try{await this.checkServerAvailable()?(this.ws=new WebSocket("ws://localhost:5001"),this.ws.onopen=()=>{console.log("Connected to WebSocket server"),this.reconnectAttempts=0,this.isServerCheckInProgress=!1,Spicetify.showNotification("WebSocket Connected!")},this.ws.onmessage=async e=>{console.log("Received in app.tsx:",e.data);var t,s=JSON.parse(e.data);switch(console.log("data: "+s),s.type){case"playback":switch(s.action){case"volume":Spicetify.Player.setVolume(s.value/100);break;case"seek":console.log(s.value),Spicetify.Player.seek(s.value);break;case"play":Spicetify.Player.play();break;case"play-uri":Spicetify.Player.playUri(s.value);break;case"pause":Spicetify.Player.pause();break;case"next":Spicetify.Player.next();break;case"prev":Spicetify.Player.back();break;case"toggle":Spicetify.Player.togglePlay();break;case"shuffle":Spicetify.Player.toggleShuffle();break;case"setRepeat":let e;switch(s.value){case"off":e=0;break;case"context":e=1;break;case"track":e=2;break;default:e=0}Spicetify.Player.setRepeat(e),this.sendMessage(JSON.stringify({type:"response",action:"repeatState",data:{state:s.value}}));break;case"toggleRepeat":let t;switch(Spicetify.Player.getRepeat()){case 0:t=1;break;case 1:t=2;break;default:t=0}Spicetify.Player.setRepeat(t),this.sendMessage(JSON.stringify({type:"response",action:"repeatState",data:{state:0===t?"off":1===t?"context":"track"}}));break;default:console.log("Unknown playback action:",s.action)}break;case"info":switch(s.action){case"token":this.sendMessage(JSON.stringify({type:"response",action:"token",data:{token:Spicetify.Platform.Session.accessToken,expiration:Spicetify.Platform.Session.accessTokenExpirationTimestampMs}}));break;case"next":var r=Spicetify.Queue.nextTracks[0].contextTrack.metadata;console.log("Next Tracks: "+JSON.stringify(Spicetify.Queue.nextTracks[0].contextTrack.metadata,null,2)),this.sendMessage(JSON.stringify({type:"response",action:"next",data:{name:r.title,artist:r.artist_name,album:r.album_title,duration:r.duration,album_cover:this.convertSpotifyImageUriToUrl(r.image_xlarge_url),year:r.album_name||"Unknown"}}));break;case"current":r=Spicetify.Player.data.item;r?(this.duration.duration=r.duration.milliseconds,this.sendMessage(JSON.stringify({type:"response",action:"current",data:{name:r.name,artist:(null==(t=null==(t=r.artists)?void 0:t[0])?void 0:t.name)||"Unknown Artist",album:(null==(t=r.album)?void 0:t.name)||"Unknown",duration_ms:(null==(t=r.duration)?void 0:t.milliseconds)||0,album_cover:this.convertSpotifyImageUriToUrl((null==(t=r.metadata)?void 0:t.image_xlarge_url)||""),volume:Math.round(100*Spicetify.Player.getVolume()),is_playing:Spicetify.Player.isPlaying(),repeat_state:Spicetify.Player.getRepeat(),shuffle_state:Spicetify.Player.getShuffle(),progress_ms:Spicetify.Player.getProgress(),progress_percentage:Math.round(100*Spicetify.Player.getProgressPercent())}}))):this.sendMessage(JSON.stringify({type:"response",action:"current",data:{name:"No Song Playing"}}))}}},this.ws.onclose=()=>{console.log("WebSocket connection closed"),this.isServerCheckInProgress=!1,this.handleReconnect()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.isServerCheckInProgress=!1}):(console.log("Server not available, waiting..."),this.isServerCheckInProgress=!1,setTimeout(()=>this.connectWebSocket(),5e3))}catch(e){console.error("Failed to create WebSocket:",e),this.isServerCheckInProgress=!1,this.handleReconnect()}}}async handleReconnect(){var e;this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),console.log(`Attempting to reconnect in ${e}ms... (Attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connectWebSocket()},e)):(console.log("Max reconnection attempts reached. Will try again when server becomes available."),this.reconnectAttempts=0,setTimeout(()=>{this.connectWebSocket()},5e3))}async main(){for(;null==Spicetify||!Spicetify.showNotification;)await new Promise(e=>setTimeout(e,100));await this.connectWebSocket(),await this.establishListeners(),Spicetify.showNotification("Hello from Iris!")}throttledSendMessage(e){var t=Date.now();t-this.lastMessageTime<this.messageThrottle||(this.lastMessageTime=t,this.sendMessage(e))}async sendMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.warn("WebSocket is not connected. Message not sent:",e)}async establishListeners(){Spicetify.Player.isPlaying()&&this.startProgressTracking(),this.listenForSongChange(),this.listenForPlayPause()}async listenForPlayPause(){Spicetify.Player.addEventListener("onplaypause",e=>{Spicetify.Player.isPlaying()?this.progressWorker?this.progressWorker.postMessage("start"):this.startProgressTracking():(this.timingSwitch=!0,this.progressWorker&&this.progressWorker.postMessage("stop"))})}async listenForSongChange(){this.duration.prevDuration=Spicetify.Player.getDuration(),console.log("starting songchange eventlistener"),Spicetify.Player.addEventListener("songchange",e=>{var t;this.loopSwitch=!1,this.progress.prevProgress>this.duration.prevDuration-3550?(this.wasAutoSwitchedThisSong=!0,t=setTimeout(()=>{this.wasAutoSwitchedThisSong=!1},2e3),this.cleanupTimers.push(t)):this.wasAutoSwitchedThisSong=!1,this.duration.prevDuration=Spicetify.Player.getDuration(),this.timingSwitch=!1})}cleanup(){this.stopProgressTracking(),this.cleanupTimers.forEach(e=>clearTimeout(e)),this.cleanupTimers=[],this.ws&&(this.ws.close(),this.ws=null),this.messageQueue=[]}},(async()=>{await e()})()})();