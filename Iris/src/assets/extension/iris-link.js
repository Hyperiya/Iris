(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var e;e=new class{constructor(){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isServerCheckInProgress=!1,this.progressWorker=null,this.wasAutoSwitchedThisSong=!1,this.timingSwitch=!1,this.progress={progress:0,prevProgress:0},this.loopSwitch=!1,this.main()}setupProgressWorker(){var e=new Blob([`
self.onmessage = function(e) {
  if (e.data === 'start') {
    setInterval(() => {
      self.postMessage('tick');
    }, 100); // Interval
  }
};
`],{type:"application/javascript"}),e=URL.createObjectURL(e);this.progressWorker=new Worker(e),Spicetify.Player.addEventListener("onplaypause",e=>{null!=e&&e.data.isPaused&&(this.timingSwitch=!0)}),this.progressWorker.onmessage=()=>{console.log("message");let e;e=!this.wasAutoSwitchedThisSong||this.timingSwitch||this.loopSwitch?(this.loopSwitch,0):-750;var t=Math.max(Spicetify.Player.getProgress()+e,0),s=Spicetify.Player.getDuration();this.progress.prevProgress=this.progress.progress,this.progress.progress=t,console.log(JSON.stringify({type:"progress",data:{progress:t,duration:s,percentage:t/s*100}})),this.sendMessage(JSON.stringify({type:"progress",data:{progress:t,duration:s,percentage:t/s*100}}))},this.progressWorker.postMessage("start"),URL.revokeObjectURL(e)}convertSpotifyImageUriToUrl(e){e=e.split(":").pop();return e?"https://i.scdn.co/image/"+e:""}startProgressTracking(){this.progressWorker||this.setupProgressWorker()}stopProgressTracking(){this.progressWorker&&(this.progressWorker.terminate(),this.progressWorker=null)}async checkServerAvailable(){try{await fetch("http://127.0.0.1:5001/health",{method:"HEAD",mode:"no-cors"});return!0}catch(e){return!1}}async connectWebSocket(){if(!this.isServerCheckInProgress){this.isServerCheckInProgress=!0;try{await this.checkServerAvailable()?(this.ws=new WebSocket("ws://localhost:5001"),this.ws.onopen=()=>{console.log("Connected to WebSocket server"),this.reconnectAttempts=0,this.isServerCheckInProgress=!1,Spicetify.showNotification("WebSocket Connected!")},this.ws.onmessage=async e=>{console.log("Received in app.tsx:",e.data);var s=JSON.parse(e.data);switch(console.log("data: "+s),s.type){case"playback":switch(s.action){case"volume":Spicetify.Player.setVolume(s.value/100);break;case"seek":console.log(s.value),Spicetify.Player.seek(s.value);break;case"play":Spicetify.Player.play();break;case"play-uri":Spicetify.Player.playUri(s.value);break;case"pause":Spicetify.Player.pause();break;case"next":Spicetify.Player.next();break;case"prev":Spicetify.Player.back();break;case"toggle":Spicetify.Player.togglePlay();break;case"shuffle":Spicetify.Player.toggleShuffle();break;case"setRepeat":let e;switch(s.value){case"off":e=0;break;case"context":e=1;break;case"track":e=2;break;default:e=0}Spicetify.Player.setRepeat(e),this.sendMessage(JSON.stringify({type:"response",action:"repeatState",data:{state:s.value}}));break;case"toggleRepeat":let t;switch(Spicetify.Player.getRepeat()){case 0:t=1;break;case 1:t=2;break;default:t=0}Spicetify.Player.setRepeat(t),this.sendMessage(JSON.stringify({type:"response",action:"repeatState",data:{state:0===t?"off":1===t?"context":"track"}}));break;default:console.log("Unknown playback action:",s.action)}break;case"info":switch(s.action){case"token":this.sendMessage(JSON.stringify({type:"response",action:"token",data:{token:Spicetify.Platform.Session.accessToken,expiration:Spicetify.Platform.Session.accessTokenExpirationTimestampMs}}));break;case"next":var a=Spicetify.Queue.nextTracks[0].contextTrack.metadata,i=null==(i=a.album_uri)?void 0:i.split(":")[2],r=Spicetify.Platform.Session.accessToken;let t;console.log("Next Tracks: "+JSON.stringify(Spicetify.Queue.nextTracks[0].contextTrack.metadata,null,2)),fetch("https://api.spotify.com/v1/albums/"+i,{headers:{Authorization:"Bearer "+r}}).then(e=>e.json()).then(e=>{t=null==(e=e.release_date)?void 0:e.split("-")[0]}),this.sendMessage(JSON.stringify({type:"response",action:"next",data:{name:a.title,artist:a.artist_name,album:a.album_title,duration:a.duration,album_cover:this.convertSpotifyImageUriToUrl(a.image_xlarge_url),year:t||2e3}}));break;case"current":i=Spicetify.Player.data.item;console.log("current track: "+i),console.log(this.songyear),this.sendMessage(JSON.stringify({type:"response",action:"current",data:{name:(null==i?void 0:i.name)||"No Song Playing",artist:(null==(a=null==(r=null==i?void 0:i.artists)?void 0:r[0])?void 0:a.name)||"Unknown Artist",album:(null==(r=null==i?void 0:i.album)?void 0:r.name)||"Unknown",duration_ms:(null==i?void 0:i.duration)||0,album_cover:this.convertSpotifyImageUriToUrl(i.metadata.image_xlarge_url),year:i.album.name||"Unknown",volume:Spicetify.Player.getVolume(),is_playing:Spicetify.Player.isPlaying(),repeat_state:Spicetify.Player.getRepeat(),shuffle_state:Spicetify.Player.getShuffle(),progress_ms:Spicetify.Player.getProgress(),progress_percentage:100*Spicetify.Player.getProgressPercent()}}))}}},this.ws.onclose=()=>{console.log("WebSocket connection closed"),this.isServerCheckInProgress=!1,this.handleReconnect()},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.isServerCheckInProgress=!1}):(console.log("Server not available, waiting..."),this.isServerCheckInProgress=!1,setTimeout(()=>this.connectWebSocket(),5e3))}catch(e){console.error("Failed to create WebSocket:",e),this.isServerCheckInProgress=!1,this.handleReconnect()}}}async handleReconnect(){var e;this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1),console.log(`Attempting to reconnect in ${e}ms... (Attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connectWebSocket()},e)):(console.log("Max reconnection attempts reached. Will try again when server becomes available."),this.reconnectAttempts=0,setTimeout(()=>{this.connectWebSocket()},5e3))}async main(){for(;null==Spicetify||!Spicetify.showNotification;)await new Promise(e=>setTimeout(e,100));await this.connectWebSocket(),await this.establishListeners(),Spicetify.showNotification("Hello from Iris!");var e=Spicetify.Player.data.item;this.getSongYear(e)}async sendMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(e):console.warn("WebSocket is not connected. Message not sent:",e)}async establishListeners(){this.startProgressTracking(),this.listenForSongChange(),this.listenForPlayPause()}async getSongYear(e){var t,s,a=Spicetify.Platform.Session.accessToken,e=null==(e=null==e?void 0:e.uri)?void 0:e.split(":")[2];try{var i=await(await fetch("https://api.spotify.com/v1/tracks/"+e,{headers:{Authorization:"Bearer "+a}})).json(),r=(console.log("Album Data: "+JSON.stringify(i,null,2)),(null==(s=null==(t=i.album)?void 0:t.release_date)?void 0:s.split("-")[0])||"Unknown Year");return this.songyear=r}catch(e){return console.error("Error fetching song year:",e),"Unknown Year"}}async listenForSongChange(){let s=Spicetify.Player.getDuration();Spicetify.Player.addEventListener("songchange",e=>{this.loopSwitch=!1,console.log("song: "+this.progress.prevProgress),this.progress.prevProgress>s-3550?(console.log("Song ended naturally"),this.wasAutoSwitchedThisSong=!0,setTimeout(()=>{},2e3)):2==Spicetify.Player.getRepeat()?this.loopSwitch=!0:(this.wasAutoSwitchedThisSong=!1,console.log("Song ended abruptly"));var t=Spicetify.Player.data.item;Spicetify.showNotification("Now Playing: "+t.name),console.log(JSON.stringify(t,null,2)),this.getSongYear(t),console.log("Song ended: Previous Duration: "+s),console.log("Song ended: Previous Progress: "+this.progress),s=Spicetify.Player.getDuration()})}async listenForPlayPause(){Spicetify.Player.addEventListener("onplaypause",e=>{Spicetify.Player.isPlaying()})}cleanup(){this.ws&&(this.ws.close(),this.ws=null)}},(async()=>{await e()})()})();