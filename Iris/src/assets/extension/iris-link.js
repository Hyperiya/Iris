(async()=>{for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(e=>setTimeout(e,10));var i,r,a,o,n,c,l,e;i=Object.defineProperty,r=Object.defineProperties,a=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,l=(e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,e=new class{constructor(){this.ws=null,this.progressWorker=null,this.reconnectAttempts=0,this.isServerCheckInProgress=!1,this.cleanupTimers=[],this.progress={current:0,previous:0},this.duration={current:0,previous:0},this.wasAutoSwitched=!1,this.timingSwitch=!1,this.loopSwitch=!1,this.initialize()}async initialize(){await this.waitForSpicetify(),await this.connectWebSocket(),this.setupEventListeners(),Spicetify.showNotification("Hello from Iris!")}async waitForSpicetify(){for(;null==Spicetify||!Spicetify.showNotification;)await new Promise(e=>setTimeout(e,100))}async connectWebSocket(){if(!this.isServerCheckInProgress){this.isServerCheckInProgress=!0;try{await this.checkServerHealth()?(this.ws=new WebSocket("ws://localhost:5001"),this.setupWebSocketHandlers()):(console.log("Server not available, retrying..."),this.scheduleReconnect(5e3))}catch(e){console.error("Failed to create WebSocket:",e),this.handleReconnect()}}}async checkServerHealth(){try{return await fetch("http://127.0.0.1:5001/health",{method:"HEAD",mode:"no-cors"}),!0}catch(e){return!1}}setupWebSocketHandlers(){this.ws&&(this.ws.onopen=()=>{console.log("Connected to WebSocket server"),this.reconnectAttempts=0,this.isServerCheckInProgress=!1,Spicetify.showNotification("WebSocket Connected!")},this.ws.onmessage=e=>this.handleWebSocketMessage(e),this.ws.onclose=()=>this.handleWebSocketClose(),this.ws.onerror=e=>this.handleWebSocketError(e))}handleWebSocketMessage(e){try{var t=JSON.parse(e.data);"playback"===t.type?this.handlePlaybackMessage(t):"info"===t.type&&this.handleInfoMessage(t)}catch(e){console.error("Error parsing WebSocket message:",e)}}handleWebSocketClose(){console.log("WebSocket connection closed"),this.isServerCheckInProgress=!1,this.handleReconnect()}handleWebSocketError(e){console.error("WebSocket error:",e),this.isServerCheckInProgress=!1}handlePlaybackMessage(e){var{action:t,value:s}=e;switch(t){case"volume":Spicetify.Player.setVolume(s/100);break;case"seek":Spicetify.Player.seek(s);break;case"play":Spicetify.Player.play();break;case"play-uri":Spicetify.Player.playUri(s);break;case"pause":Spicetify.Player.pause();break;case"next":Spicetify.Player.next();break;case"prev":Spicetify.Player.back();break;case"toggle":Spicetify.Player.togglePlay();break;case"shuffle":Spicetify.Player.toggleShuffle();break;case"setRepeat":this.handleSetRepeat(s);break;case"toggleRepeat":this.handleToggleRepeat();break;default:console.log("Unknown playback action:",t)}}handleInfoMessage(e){e=e.action;switch(e){case"token":this.sendTokenInfo();break;case"next":this.sendNextTrackInfo();break;case"current":this.sendCurrentTrackInfo();break;case"playlists":this.sendPlaylists()}}handleSetRepeat(e){var t=null!=(t={off:0,context:1,track:2}[e])?t:0;Spicetify.Player.setRepeat(t),this.sendMessage({type:"response",action:"repeatState",data:{state:e}})}handleToggleRepeat(){var e=(Spicetify.Player.getRepeat()+1)%3;Spicetify.Player.setRepeat(e),this.sendMessage({type:"response",action:"repeatState",data:{state:["off","context","track"][e]}})}sendTokenInfo(){this.sendMessage({type:"response",action:"token",data:{token:Spicetify.Platform.Session.accessToken,expiration:Spicetify.Platform.Session.accessTokenExpirationTimestampMs}})}sendNextTrackInfo(){var e=null==(e=null==(e=Spicetify.Queue.nextTracks[0])?void 0:e.contextTrack)?void 0:e.metadata;e&&this.sendMessage({type:"response",action:"next",data:{name:e.title,artist:e.artist_name,album:e.album_title,duration:e.duration,album_cover:this.convertSpotifyImageUri(e.image_xlarge_url),year:e.album_name||"Unknown"}})}async sendPlaylists(){var e=await Spicetify.CosmosAsync.get("sp://core-playlist/v1/rootlist"),e=(console.log("playlists",e),e.rows.map(e=>{var t,s;return s=((e,t)=>{for(var s in t=t||{})n.call(t,s)&&l(e,s,t[s]);if(o)for(var s of o(t))c.call(t,s)&&l(e,s,t[s]);return e})({},e),e={picture:null!=(t=e.picture)&&t.startsWith("spotify:mosaic:")?e.picture.split(":").slice(2).map(e=>"https://i.scdn.co/image/"+e):null!=(t=e.picture)&&t.startsWith("spotify:image:")?this.convertSpotifyImageUri(e.picture):e.picture,mosaic:null==(t=e.picture)?void 0:t.startsWith("spotify:mosaic:")},r(s,a(e))}));console.log(e),this.sendMessage({type:"response",action:"playlists",data:e})}sendCurrentTrackInfo(){var e,t=Spicetify.Player.data.item;t?(this.duration.current=t.duration.milliseconds,this.sendMessage({type:"response",action:"current",data:{name:t.name,artist:(null==(e=null==(e=t.artists)?void 0:e[0])?void 0:e.name)||"Unknown Artist",album:(null==(e=t.album)?void 0:e.name)||"Unknown",duration_ms:(null==(e=t.duration)?void 0:e.milliseconds)||0,album_cover:this.convertSpotifyImageUri((null==(e=t.metadata)?void 0:e.image_xlarge_url)||""),volume:Math.round(100*Spicetify.Player.getVolume()),is_playing:Spicetify.Player.isPlaying(),repeat_state:Spicetify.Player.getRepeat(),shuffle_state:Spicetify.Player.getShuffle(),progress_ms:Spicetify.Player.getProgress(),progress_percentage:Math.round(100*Spicetify.Player.getProgressPercent()),id:(t.uri||"").split(":").pop()||""}})):this.sendMessage({type:"response",action:"current",data:{name:"No Song Playing"}})}setupEventListeners(){this.startProgressTracking(),this.setupSongChangeListener()}setupSongChangeListener(){this.duration.previous=Spicetify.Player.getDuration(),Spicetify.Player.addEventListener("songchange",()=>{var e;this.loopSwitch=!1,this.progress.previous>this.duration.previous-3550?(this.wasAutoSwitched=!0,e=setTimeout(()=>{this.wasAutoSwitched=!1},2e3),this.cleanupTimers.push(e)):this.wasAutoSwitched=!1,this.duration.previous=Spicetify.Player.getDuration(),this.timingSwitch=!1}),Spicetify.Player.addEventListener("onplaypause",e=>{null!=e&&e.data.isPaused&&(this.timingSwitch=!0)})}startProgressTracking(){var e,t;this.progressWorker||(this.progressWorker=(e=100,e=new Blob([`
    let intervalId;
    self.onmessage = function(e) {
      if (e.data === 'start') {
        intervalId = setInterval(() => {
          self.postMessage('tick');
        }, ${e});
      } else if (e.data === 'stop') {
        clearInterval(intervalId);
      }
    };
  `],{type:"application/javascript"}),e=URL.createObjectURL(e),t=new Worker(e),URL.revokeObjectURL(e),t),this.progressWorker.onmessage=()=>{this.updateProgress()},this.progressWorker.postMessage("start"))}updateProgress(){1e3<=this.duration.previous-this.progress.previous&&this.progress.current<=500&&2===Spicetify.Player.getRepeat()&&(this.loopSwitch=!0);let e=0;!this.wasAutoSwitched&&!this.loopSwitch||this.timingSwitch||(e=-750);var t=Math.max(Spicetify.Player.getProgress()+e,0),s=Spicetify.Player.getDuration();this.progress.previous=this.progress.current,this.progress.current=t,this.sendMessage({type:"progress",data:{progress:t,duration:s,percentage:t/s*100}})}stopProgressTracking(){this.progressWorker&&(this.progressWorker.postMessage("stop"),this.progressWorker.terminate(),this.progressWorker=null)}handleReconnect(){var e;this.reconnectAttempts<5?(this.reconnectAttempts++,e=1e3*Math.pow(2,this.reconnectAttempts-1),console.log(`Reconnecting in ${e}ms... (Attempt ${this.reconnectAttempts})`),this.scheduleReconnect(e)):(console.log("Max reconnection attempts reached. Checking server periodically..."),this.reconnectAttempts=0,this.scheduleReconnect(5e3))}scheduleReconnect(e){this.isServerCheckInProgress=!1,setTimeout(()=>this.connectWebSocket(),e)}convertSpotifyImageUri(e){e=e.split(":").pop();return e?"https://i.scdn.co/image/"+e:""}sendMessage(e){var t;(null==(t=this.ws)?void 0:t.readyState)===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("WebSocket not connected. Message not sent:",e)}cleanup(){this.stopProgressTracking(),this.cleanupTimers.forEach(e=>clearTimeout(e)),this.cleanupTimers=[],this.ws&&(this.ws.close(),this.ws=null)}},(async()=>{await e()})()})();